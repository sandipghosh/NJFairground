@using NJFairground.Web.Models
@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayoutPage.cshtml";
}
@section AdimnPageScripts{
    <script src="http://malsup.github.com/jquery.form.js"></script>
    <script src="//tinymce.cachefly.net/4.2/tinymce.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $(document).on('change', '#page-selection', function () {
                var $self = $(this);
                var selectedPage = $self.find('option:selected').val();

                $.ajax({
                    method: "GET",
                    url: '@Url.Content("~/")' + 'Admin/SubPageList/GetPageItems?pageId=' + selectedPage,
                    success: function (data, textStatus, jqXHR) {
                        try {
                            $('#data-grid').html(data);
                            $('#grid-selection').show();
                            $('#data-grid table').dataTable();
                        } catch (ex) { }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert(textStatus);
                    }
                });
            });
        });

        GetEditScreen = function (data) {
            $('#grid-selection').hide();
            if (data.responseText)
                $('#data-grid').html(data.responseText);
            else
                $('#data-grid').html(data);
            GetEditor('textarea#PageItemDetailText, textarea#PageSubHeaderText');
        };

        GetEditor = function (selector) {
            tinymce.init({
                selector: selector,
                theme: "modern",
                menubar: false,
                statusbar: false,
                plugins: [
                     "advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker",
                     "searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking",
                     "save table contextmenu directionality emoticons template paste textcolor code"
                ],
                toolbar: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | preview media fullpage | forecolor backcolor emoticons code",
            });
        }

        ShowSubPageInsertScreen = function (data) {
            if (data.responseText) {
                $('#data-grid').html(data.responseText);
                $.validator.unobtrusive.parse($(data.responseText));
            }
            else {
                $('#data-grid').html(data);
                $.validator.unobtrusive.parse($(data));
            }

            if ($('#data-grid:has(table)').length > 0) {
                $('#grid-selection').show();
                $('#data-grid table').dataTable();
            }
            else {
                $('#grid-selection').hide();
                tinymce.EditorManager.execCommand('mceRemoveEditor', true, 'PageItemDetailText');
                tinymce.EditorManager.execCommand('mceRemoveEditor', true, 'PageSubHeaderText');
                GetEditor('textarea#PageItemDetailText, textarea#PageSubHeaderText');

                EnableUpload();
            }
        };

        AddSelectedPageId = function (data, hdata) {
            if (hdata.url) {
                var urlData = hdata.url.split('?');
                if (urlData.length > 0)
                    hdata.url = urlData[0] + '?pageId=' + $('#page-selection :selected').val() + '&' + urlData[1];
            }
        };

        EnableUpload = function () {
            window.addEventListener("submit", function (e) {
                var form = e.target;
                if (form.getAttribute("enctype") === "multipart/form-data") {
                    if (form.dataset.ajax) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        tinyMCE.triggerSave(true, true);

                        var xhr = new XMLHttpRequest();
                        xhr.open(form.method, form.action);
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == 4 && xhr.status == 200) {
                                /*if (form.dataset.ajaxUpdate) {
                                    var updateTarget = document.querySelector(form.dataset.ajaxUpdate);
                                    if (updateTarget) {
                                        updateTarget.innerHTML = xhr.responseText;
                                    }
                                }*/
                                ShowSubPageInsertScreen(xhr.responseText)
                            }
                        };
                        xhr.send(new FormData(form));
                    }
                }
            }, true);
        };
    </script>
}

<div class="row">
    <div class="col-lg-12">
        <h1 class="page-header">Sub Screen</h1>
    </div>
</div>
<div class="row">
    <div class="col-lg-12">
        <div class="panel panel-default">
            <div class="panel-heading">Screens</div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-lg-12">
                        <div id="grid-selection" class="form-group">
                            <label>Select Screen</label>
                            @Html.DropDownList("Page", (IEnumerable<SelectListItem>)ViewBag.Pages, new { @class = "form-control", id = "page-selection" })
                        </div>
                        <div class="form-group" id="data-grid"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
